<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2600" font-family="'Segoe UI', 'Helvetica Neue', Arial, sans-serif">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#0a0a1a"/><stop offset="100%" style="stop-color:#0d1117"/>
    </linearGradient>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#0f0c29"/><stop offset="50%" style="stop-color:#302b63"/><stop offset="100%" style="stop-color:#24243e"/>
    </linearGradient>
    <linearGradient id="accent1" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#f093fb"/><stop offset="100%" style="stop-color:#f5576c"/>
    </linearGradient>
    <linearGradient id="fwdGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#4facfe"/><stop offset="100%" style="stop-color:#00f2fe"/>
    </linearGradient>
    <linearGradient id="bwdGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#fa709a"/><stop offset="100%" style="stop-color:#fee140"/>
    </linearGradient>
    <linearGradient id="fp8Grad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ff6b6b"/><stop offset="100%" style="stop-color:#ffa502"/>
    </linearGradient>
    <linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#43e97b"/><stop offset="100%" style="stop-color:#38f9d7"/>
    </linearGradient>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="0" dy="4" stdDeviation="8" flood-color="#000" flood-opacity="0.4"/>
    </filter>
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="#4facfe">
      <polygon points="0 0, 10 3.5, 0 7"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="#ffa502">
      <polygon points="0 0, 10 3.5, 0 7"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="#43e97b">
      <polygon points="0 0, 10 3.5, 0 7"/>
    </marker>
    <marker id="arrowPink" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="#fa709a">
      <polygon points="0 0, 10 3.5, 0 7"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="#a18cd1">
      <polygon points="0 0, 10 3.5, 0 7"/>
    </marker>
    <pattern id="dots" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
      <circle cx="20" cy="20" r="0.8" fill="#ffffff" opacity="0.04"/>
    </pattern>
  </defs>

  <!-- Background -->
  <rect width="1400" height="2600" fill="url(#bgGrad)"/>
  <rect width="1400" height="2600" fill="url(#dots)"/>

  <!-- ===================== HEADER ===================== -->
  <rect x="40" y="30" width="1320" height="130" rx="18" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <rect x="40" y="30" width="1320" height="130" rx="18" fill="none" stroke="url(#accent1)" stroke-width="1.5" opacity="0.5"/>
  <rect x="70" y="55" width="6" height="80" rx="3" fill="url(#accent1)"/>
  <text x="95" y="90" fill="#ffffff" font-size="30" font-weight="bold">Mixed Precision Framework</text>
  <text x="95" y="118" fill="#8b8baa" font-size="15" letter-spacing="1.5">ONLINE QUANTIZATION â€¢ FP8 GEMM â€¢ FORWARD &amp; BACKWARD PASS</text>
  <text x="95" y="142" fill="#f093fb" font-size="12">DeepSeek Quantization Technique â€” Part 2 of 6</text>
  <rect x="1100" y="60" width="230" height="40" rx="8" fill="#f093fb" opacity="0.15" stroke="#f093fb" stroke-width="1"/>
  <text x="1215" y="85" text-anchor="middle" fill="#f093fb" font-size="13" font-weight="bold">CORE FRAMEWORK</text>

  <!-- ===================== OVERVIEW ===================== -->
  <rect x="40" y="190" width="1320" height="160" rx="14" fill="#111128" filter="url(#shadow)"/>
  <rect x="40" y="190" width="1320" height="160" rx="14" fill="none" stroke="#667eea" stroke-width="1" opacity="0.3"/>
  <text x="80" y="228" fill="#c8c8e8" font-size="18" font-weight="bold">Core Idea: On-the-Fly Quantization for GEMM Operations</text>
  <line x1="80" y1="240" x2="580" y2="240" stroke="url(#accent1)" stroke-width="2" opacity="0.5"/>
  <text x="80" y="268" fill="#ddd" font-size="13">DeepSeek keeps weights and activations in higher precision (BF16/FP32) and converts them to FP8 <tspan font-weight="bold" fill="#ff6b6b">on-the-fly</tspan></text>
  <text x="80" y="290" fill="#ddd" font-size="13">only during General Matrix Multiply (GEMM) operations, then immediately casts results back to higher precision.</text>
  <text x="80" y="320" fill="#43e97b" font-size="13" font-weight="bold">This provides ~2Ã— speedup for GEMM while maintaining numerical stability for all other operations.</text>
  <text x="80" y="340" fill="#8b8baa" font-size="11" font-style="italic">"Online" means quantization happens dynamically at runtime â€” no pre-calibration needed.</text>

  <!-- ===================== FORWARD PASS ===================== -->
  <rect x="40" y="380" width="1320" height="620" rx="14" fill="#111128" filter="url(#shadow)"/>
  <rect x="40" y="380" width="1320" height="620" rx="14" fill="none" stroke="#4facfe" stroke-width="1.5" opacity="0.4"/>
  <rect x="40" y="380" width="1320" height="48" rx="14" fill="#4facfe" opacity="0.08"/>
  <rect x="40" y="414" width="1320" height="14" fill="#111128"/>
  <circle cx="80" cy="404" r="16" fill="#4facfe" opacity="0.3" stroke="#4facfe" stroke-width="1.5"/>
  <text x="80" y="410" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">F</text>
  <text x="110" y="412" fill="#4facfe" font-size="20" font-weight="bold">Forward Pass: y = Wx</text>
  <text x="380" y="412" fill="#8b8baa" font-size="13">Computing output activations from inputs and weights</text>

  <!-- Step-by-step flow -->
  <text x="80" y="455" fill="#667eea" font-size="14" font-weight="bold" letter-spacing="1">DATA FLOW PIPELINE</text>

  <!-- Step 1: Higher precision inputs -->
  <g transform="translate(80, 475)">
    <rect x="0" y="0" width="250" height="130" rx="10" fill="#0a1a2a" stroke="#4facfe" stroke-width="2"/>
    <rect x="0" y="0" width="250" height="30" rx="10" fill="#4facfe" opacity="0.1"/>
    <rect x="0" y="22" width="250" height="8" fill="#0a1a2a"/>
    <text x="125" y="22" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">STEP 1: Stored Tensors</text>
    
    <rect x="15" y="42" width="220" height="35" rx="6" fill="#0a0a20" stroke="#4facfe" stroke-width="1"/>
    <text x="125" y="58" text-anchor="middle" fill="#4facfe" font-size="13" font-weight="bold">Weights W</text>
    <text x="125" y="73" text-anchor="middle" fill="#8b8baa" font-size="10">BF16 / FP32</text>
    
    <rect x="15" y="85" width="220" height="35" rx="6" fill="#0a0a20" stroke="#4facfe" stroke-width="1"/>
    <text x="125" y="101" text-anchor="middle" fill="#4facfe" font-size="13" font-weight="bold">Activations x</text>
    <text x="125" y="116" text-anchor="middle" fill="#8b8baa" font-size="10">BF16 / FP32</text>
  </g>

  <!-- Arrow 1â†’2 -->
  <g transform="translate(340, 530)">
    <line x1="0" y1="0" x2="100" y2="0" stroke="#ffa502" stroke-width="3" stroke-dasharray="8,4" marker-end="url(#arrowOrange)"/>
    <text x="50" y="-10" text-anchor="middle" fill="#ffa502" font-size="11" font-weight="bold">Quantize</text>
    <text x="50" y="18" text-anchor="middle" fill="#ffa502" font-size="10">on-the-fly</text>
  </g>

  <!-- Step 2: Quantization -->
  <g transform="translate(455, 475)">
    <rect x="0" y="0" width="260" height="130" rx="10" fill="#1a0a0a" stroke="#ffa502" stroke-width="2"/>
    <rect x="0" y="0" width="260" height="30" rx="10" fill="#ffa502" opacity="0.1"/>
    <rect x="0" y="22" width="260" height="8" fill="#1a0a0a"/>
    <text x="130" y="22" text-anchor="middle" fill="#ffa502" font-size="12" font-weight="bold">STEP 2: Online Quantization</text>
    
    <text x="20" y="50" fill="#ddd" font-size="11">For each tensor (per group):</text>
    <text x="20" y="70" fill="#ffa502" font-size="11" font-weight="bold">scale = max_fp8 / max(|tensor|)</text>
    <text x="20" y="90" fill="#ddd" font-size="11">quantized = round(tensor Ã— scale)</text>
    <text x="20" y="115" fill="#ff6b6b" font-size="12" font-weight="bold">â†’ W_FP8, x_FP8</text>
  </g>

  <!-- Arrow 2â†’3 -->
  <g transform="translate(725, 530)">
    <line x1="0" y1="0" x2="90" y2="0" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowBlue)"/>
    <text x="45" y="-10" text-anchor="middle" fill="#ff6b6b" font-size="11" font-weight="bold">FP8</text>
  </g>

  <!-- Step 3: GEMM -->
  <g transform="translate(830, 475)">
    <rect x="0" y="0" width="230" height="130" rx="10" fill="#2a0a0a" stroke="#ff6b6b" stroke-width="2.5"/>
    <rect x="0" y="0" width="230" height="30" rx="10" fill="#ff6b6b" opacity="0.15"/>
    <rect x="0" y="22" width="230" height="8" fill="#2a0a0a"/>
    <text x="115" y="22" text-anchor="middle" fill="#ff6b6b" font-size="12" font-weight="bold">STEP 3: FP8 GEMM</text>
    
    <text x="115" y="55" text-anchor="middle" fill="#fff" font-size="16" font-weight="bold">y = W_FP8 Ã— x_FP8</text>
    
    <rect x="20" y="70" width="190" height="42" rx="6" fill="#ff6b6b" opacity="0.15" stroke="#ff6b6b" stroke-width="1"/>
    <text x="115" y="88" text-anchor="middle" fill="#ff6b6b" font-size="14" font-weight="bold">âš¡ 2Ã— FASTER</text>
    <text x="115" y="105" text-anchor="middle" fill="#8b8baa" font-size="10">vs BF16 GEMM</text>
  </g>

  <!-- Arrow 3â†’4 -->
  <g transform="translate(1070, 530)">
    <line x1="0" y1="0" x2="90" y2="0" stroke="#43e97b" stroke-width="3" marker-end="url(#arrowGreen)"/>
    <text x="45" y="-10" text-anchor="middle" fill="#43e97b" font-size="11" font-weight="bold">Upcast</text>
  </g>

  <!-- Step 4: Output -->
  <g transform="translate(1170, 475)">
    <rect x="0" y="0" width="170" height="130" rx="10" fill="#0a2a1a" stroke="#43e97b" stroke-width="2"/>
    <rect x="0" y="0" width="170" height="30" rx="10" fill="#43e97b" opacity="0.1"/>
    <rect x="0" y="22" width="170" height="8" fill="#0a2a1a"/>
    <text x="85" y="22" text-anchor="middle" fill="#43e97b" font-size="12" font-weight="bold">STEP 4: Output</text>
    
    <text x="85" y="55" text-anchor="middle" fill="#43e97b" font-size="16" font-weight="bold">y</text>
    <text x="85" y="80" text-anchor="middle" fill="#ddd" font-size="12">Stored in</text>
    <text x="85" y="100" text-anchor="middle" fill="#4facfe" font-size="14" font-weight="bold">BF16</text>
    <text x="85" y="118" text-anchor="middle" fill="#8b8baa" font-size="10">(higher precision)</text>
  </g>

  <!-- Key detail boxes -->
  <g transform="translate(80, 625)">
    <rect x="0" y="0" width="400" height="80" rx="8" fill="#0a0a20" stroke="#4facfe" stroke-width="1"/>
    <text x="20" y="22" fill="#4facfe" font-size="12" font-weight="bold">Why On-the-Fly?</text>
    <text x="20" y="42" fill="#ddd" font-size="11">No pre-computed scales needed. Scale factors are</text>
    <text x="20" y="58" fill="#ddd" font-size="11">computed per-batch from actual tensor statistics,</text>
    <text x="20" y="74" fill="#43e97b" font-size="11">ensuring optimal quantization for every input.</text>

    <rect x="420" y="0" width="400" height="80" rx="8" fill="#0a0a20" stroke="#ffa502" stroke-width="1"/>
    <text x="440" y="22" fill="#ffa502" font-size="12" font-weight="bold">Memory Impact</text>
    <text x="440" y="42" fill="#ddd" font-size="11">FP8 tensors use 1 byte vs 2 bytes (BF16) per element.</text>
    <text x="440" y="58" fill="#ddd" font-size="11">During GEMM, GPU processes 2Ã— more data per cycle,</text>
    <text x="440" y="74" fill="#43e97b" font-size="11">doubling throughput while halving memory bandwidth.</text>

    <rect x="840" y="0" width="480" height="80" rx="8" fill="#0a0a20" stroke="#43e97b" stroke-width="1"/>
    <text x="860" y="22" fill="#43e97b" font-size="12" font-weight="bold">Numerical Safety</text>
    <text x="860" y="42" fill="#ddd" font-size="11">Conversion to FP8 is ONLY for matrix multiplication.</text>
    <text x="860" y="58" fill="#ddd" font-size="11">All non-linear operations (LayerNorm, softmax, GELU)</text>
    <text x="860" y="74" fill="#ddd" font-size="11">remain in BF16/FP32, preserving numerical quality.</text>
  </g>

  <!-- Forward pass formula -->
  <rect x="80" y="730" width="1240" height="45" rx="8" fill="#0a0a20" stroke="#4facfe" stroke-width="1.5"/>
  <text x="700" y="760" text-anchor="middle" fill="#fff" font-size="15">y<tspan fill="#8b8baa" font-size="12">BF16</tspan> = Quantize(W)<tspan fill="#ff6b6b" font-size="12">FP8</tspan> Ã— Quantize(x)<tspan fill="#ff6b6b" font-size="12">FP8</tspan>  â†’  Dequantize  â†’  y<tspan fill="#4facfe" font-size="12">BF16</tspan></text>

  <!-- Phase label -->
  <rect x="80" y="790" width="400" height="30" rx="6" fill="#4facfe" opacity="0.1" stroke="#4facfe" stroke-width="1"/>
  <text x="280" y="811" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">Phase details: FP8 used ONLY during the multiply step</text>

  <!-- ===================== BACKWARD PASS â€” DGRAD ===================== -->
  <rect x="40" y="1030" width="1320" height="500" rx="14" fill="#111128" filter="url(#shadow)"/>
  <rect x="40" y="1030" width="1320" height="500" rx="14" fill="none" stroke="#a18cd1" stroke-width="1.5" opacity="0.4"/>
  <rect x="40" y="1030" width="1320" height="48" rx="14" fill="#a18cd1" opacity="0.08"/>
  <rect x="40" y="1064" width="1320" height="14" fill="#111128"/>
  <circle cx="80" cy="1054" r="16" fill="#a18cd1" opacity="0.3" stroke="#a18cd1" stroke-width="1.5"/>
  <text x="80" y="1060" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">B</text>
  <text x="110" y="1062" fill="#a18cd1" font-size="20" font-weight="bold">Backward Pass â€” Dgrad (Activation Gradient)</text>

  <!-- Formula -->
  <rect x="80" y="1095" width="1240" height="55" rx="10" fill="#0a0a20" stroke="#a18cd1" stroke-width="2"/>
  <text x="700" y="1130" text-anchor="middle" fill="#fff" font-size="20" font-weight="bold">âˆ‚L/âˆ‚x = âˆ‚L/âˆ‚z Ã— W<tspan baseline-shift="super" font-size="14">T</tspan></text>

  <text x="80" y="1180" fill="#ddd" font-size="13">Computes how much each input activation contributed to the loss. Required for backpropagating gradients to previous layers.</text>

  <!-- Dgrad flow -->
  <g transform="translate(80, 1200)">
    <!-- Loss gradient -->
    <rect x="0" y="0" width="220" height="110" rx="10" fill="#1a1a30" stroke="#a18cd1" stroke-width="2"/>
    <rect x="0" y="0" width="220" height="28" rx="10" fill="#a18cd1" opacity="0.1"/>
    <rect x="0" y="20" width="220" height="8" fill="#1a1a30"/>
    <text x="110" y="22" text-anchor="middle" fill="#a18cd1" font-size="11" font-weight="bold">Loss Gradient</text>
    <text x="110" y="55" text-anchor="middle" fill="#a18cd1" font-size="16" font-weight="bold">âˆ‚L/âˆ‚z</text>
    <text x="110" y="78" text-anchor="middle" fill="#8b8baa" font-size="10">From downstream</text>
    <text x="110" y="95" text-anchor="middle" fill="#8b8baa" font-size="10">(BF16)</text>

    <!-- Quantize -->
    <line x1="225" y1="55" x2="325" y2="55" stroke="#ffa502" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowOrange)"/>
    <text x="275" y="45" text-anchor="middle" fill="#ffa502" font-size="10" font-weight="bold">Quantize</text>

    <rect x="330" y="20" width="120" height="70" rx="8" fill="#2a0a0a" stroke="#ff6b6b" stroke-width="1.5"/>
    <text x="390" y="50" text-anchor="middle" fill="#ff6b6b" font-size="12" font-weight="bold">âˆ‚L/âˆ‚z</text>
    <text x="390" y="70" text-anchor="middle" fill="#ff6b6b" font-size="11">FP8</text>

    <!-- Weights -->
    <rect x="0" y="130" width="220" height="70" rx="10" fill="#0a1a2a" stroke="#4facfe" stroke-width="2"/>
    <text x="110" y="162" text-anchor="middle" fill="#4facfe" font-size="14" font-weight="bold">W<tspan baseline-shift="super" font-size="10">T</tspan></text>
    <text x="110" y="185" text-anchor="middle" fill="#8b8baa" font-size="10">(BF16)</text>

    <line x1="225" y1="165" x2="325" y2="165" stroke="#ffa502" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowOrange)"/>
    <text x="275" y="155" text-anchor="middle" fill="#ffa502" font-size="10" font-weight="bold">Quantize</text>

    <rect x="330" y="130" width="120" height="70" rx="8" fill="#2a0a0a" stroke="#ff6b6b" stroke-width="1.5"/>
    <text x="390" y="160" text-anchor="middle" fill="#ff6b6b" font-size="12" font-weight="bold">W<tspan baseline-shift="super" font-size="10">T</tspan></text>
    <text x="390" y="180" text-anchor="middle" fill="#ff6b6b" font-size="11">FP8</text>

    <!-- GEMM -->
    <line x1="455" y1="55" x2="530" y2="105" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowPurple)"/>
    <line x1="455" y1="165" x2="530" y2="115" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowPurple)"/>
    
    <rect x="535" y="70" width="200" height="80" rx="10" fill="#2a0a0a" stroke="#ff6b6b" stroke-width="2.5"/>
    <text x="635" y="100" text-anchor="middle" fill="#ff6b6b" font-size="14" font-weight="bold">FP8 GEMM</text>
    <text x="635" y="120" text-anchor="middle" fill="#ffa502" font-size="12">âš¡ 2Ã— Speedup</text>
    <text x="635" y="140" text-anchor="middle" fill="#8b8baa" font-size="10">FP32 accumulation</text>

    <!-- Result -->
    <line x1="740" y1="110" x2="840" y2="110" stroke="#43e97b" stroke-width="3" marker-end="url(#arrowGreen)"/>
    <text x="790" y="100" text-anchor="middle" fill="#43e97b" font-size="10" font-weight="bold">Upcast</text>

    <rect x="845" y="70" width="230" height="80" rx="10" fill="#0a2a1a" stroke="#43e97b" stroke-width="2"/>
    <text x="960" y="98" text-anchor="middle" fill="#43e97b" font-size="16" font-weight="bold">âˆ‚L/âˆ‚x</text>
    <text x="960" y="120" text-anchor="middle" fill="#ddd" font-size="12">Stored in <tspan fill="#4facfe" font-weight="bold">BF16</tspan></text>
    <text x="960" y="140" text-anchor="middle" fill="#8b8baa" font-size="10">â†’ sent to previous layer</text>
  </g>

  <rect x="80" y="1430" width="1240" height="42" rx="6" fill="#0a0a20" stroke="#a18cd1" stroke-width="1"/>
  <text x="100" y="1456" fill="#a18cd1" font-size="12" font-weight="bold">KEY:</text>
  <text x="155" y="1456" fill="#ddd" font-size="12">Both gradient and transposed weights are quantized to FP8 for the GEMM. Result is upcast to BF16 for numerical stability.</text>

  <!-- ===================== BACKWARD PASS â€” WGRAD ===================== -->
  <rect x="40" y="1560" width="1320" height="440" rx="14" fill="#111128" filter="url(#shadow)"/>
  <rect x="40" y="1560" width="1320" height="440" rx="14" fill="none" stroke="#fa709a" stroke-width="1.5" opacity="0.4"/>
  <rect x="40" y="1560" width="1320" height="48" rx="14" fill="#fa709a" opacity="0.08"/>
  <rect x="40" y="1594" width="1320" height="14" fill="#111128"/>
  <circle cx="80" cy="1584" r="16" fill="#fa709a" opacity="0.3" stroke="#fa709a" stroke-width="1.5"/>
  <text x="80" y="1590" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">W</text>
  <text x="110" y="1592" fill="#fa709a" font-size="20" font-weight="bold">Backward Pass â€” Wgrad (Weight Gradient)</text>
  <rect x="730" y="1570" width="160" height="28" rx="6" fill="#e74c3c" opacity="0.2" stroke="#e74c3c" stroke-width="1"/>
  <text x="810" y="1590" text-anchor="middle" fill="#e74c3c" font-size="12" font-weight="bold">âš  CRITICAL STEP</text>

  <!-- Formula -->
  <rect x="80" y="1620" width="1240" height="55" rx="10" fill="#0a0a20" stroke="#fa709a" stroke-width="2"/>
  <text x="700" y="1655" text-anchor="middle" fill="#fff" font-size="20" font-weight="bold">âˆ‚L/âˆ‚W = x<tspan baseline-shift="super" font-size="14">T</tspan> Ã— âˆ‚L/âˆ‚z</text>

  <text x="80" y="1705" fill="#ddd" font-size="13">Computes how much each weight contributed to the loss. These gradients are used to UPDATE the model weights â€” the core of learning.</text>

  <!-- Why FP32 updates matter -->
  <rect x="80" y="1730" width="1240" height="150" rx="10" fill="#1a0a0a" stroke="#e74c3c" stroke-width="2"/>
  <text x="100" y="1758" fill="#e74c3c" font-size="15" font-weight="bold">âš  Why Weight Updates MUST Stay in FP32</text>
  
  <g transform="translate(100, 1775)">
    <text x="0" y="0" fill="#ddd" font-size="12">In deep learning, weight updates follow:</text>
    <text x="0" y="22" fill="#fff" font-size="14" font-weight="bold">W_new = W_old - learning_rate Ã— âˆ‚L/âˆ‚W</text>
    <text x="0" y="48" fill="#ddd" font-size="12">With learning rates like 1e-4 or smaller, the update (lr Ã— gradient) can be <tspan fill="#ff6b6b" font-weight="bold">extremely small</tspan>.</text>
    <text x="0" y="70" fill="#ddd" font-size="12">In FP8 or even BF16, these tiny updates would round to <tspan fill="#ff6b6b" font-weight="bold">zero</tspan> â€” the model stops learning!</text>
    <text x="0" y="95" fill="#43e97b" font-size="13" font-weight="bold">â†’ DeepSeek stores and updates master weights in FP32 to capture every small gradient step.</text>
  </g>

  <!-- Weight update flow -->
  <g transform="translate(80, 1900)">
    <rect x="0" y="0" width="250" height="60" rx="8" fill="#1a1a30" stroke="#fa709a" stroke-width="1.5"/>
    <text x="125" y="25" text-anchor="middle" fill="#fa709a" font-size="13" font-weight="bold">Weight Gradient âˆ‚L/âˆ‚W</text>
    <text x="125" y="48" text-anchor="middle" fill="#8b8baa" font-size="10">Computed via FP8 GEMM</text>

    <line x1="255" y1="30" x2="345" y2="30" stroke="#fa709a" stroke-width="2" marker-end="url(#arrowPink)"/>

    <rect x="350" y="0" width="300" height="60" rx="8" fill="#0a2a1a" stroke="#43e97b" stroke-width="2"/>
    <text x="500" y="25" text-anchor="middle" fill="#43e97b" font-size="13" font-weight="bold">FP32 Weight Update</text>
    <text x="500" y="48" text-anchor="middle" fill="#ddd" font-size="10">W_FP32 -= lr Ã— âˆ‚L/âˆ‚W_FP32</text>

    <line x1="655" y1="30" x2="745" y2="30" stroke="#43e97b" stroke-width="2" marker-end="url(#arrowGreen)"/>

    <rect x="750" y="0" width="250" height="60" rx="8" fill="#0a1a2a" stroke="#4facfe" stroke-width="1.5"/>
    <text x="875" y="25" text-anchor="middle" fill="#4facfe" font-size="13" font-weight="bold">Updated W (FP32)</text>
    <text x="875" y="48" text-anchor="middle" fill="#8b8baa" font-size="10">Cast to FP8 next forward pass</text>
  </g>

  <!-- ===================== SUMMARY BOX ===================== -->
  <rect x="40" y="2030" width="1320" height="280" rx="14" fill="#111128" filter="url(#shadow)"/>
  <rect x="40" y="2030" width="1320" height="280" rx="14" fill="none" stroke="#667eea" stroke-width="1" opacity="0.3"/>
  <text x="700" y="2070" text-anchor="middle" fill="#c8c8e8" font-size="18" font-weight="bold">Precision Assignment Strategy â€” Complete Overview</text>

  <!-- Table -->
  <g transform="translate(80, 2090)">
    <!-- Header -->
    <rect x="0" y="0" width="250" height="35" rx="0" fill="#667eea" opacity="0.2"/>
    <text x="125" y="23" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Operation</text>
    <rect x="250" y="0" width="200" height="35" rx="0" fill="#667eea" opacity="0.2"/>
    <text x="350" y="23" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Precision Used</text>
    <rect x="450" y="0" width="200" height="35" rx="0" fill="#667eea" opacity="0.2"/>
    <text x="550" y="23" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Why</text>
    <rect x="650" y="0" width="530" height="35" rx="0" fill="#667eea" opacity="0.2"/>
    <text x="915" y="23" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Impact</text>

    <!-- Row 1 -->
    <rect x="0" y="40" width="250" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="15" y="62" fill="#ff6b6b" font-size="11" font-weight="bold">GEMM (Forward + Backward)</text>
    <rect x="250" y="40" width="200" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="350" y="62" text-anchor="middle" fill="#ff6b6b" font-size="12" font-weight="bold">FP8 (E4M3)</text>
    <rect x="450" y="40" width="200" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="550" y="62" text-anchor="middle" fill="#ddd" font-size="11">Speed</text>
    <rect x="650" y="40" width="530" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="665" y="62" fill="#43e97b" font-size="11">~2Ã— throughput, 50% memory bandwidth reduction</text>

    <!-- Row 2 -->
    <rect x="0" y="80" width="250" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="15" y="102" fill="#4facfe" font-size="11" font-weight="bold">Activation Storage</text>
    <rect x="250" y="80" width="200" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="350" y="102" text-anchor="middle" fill="#4facfe" font-size="12" font-weight="bold">BF16</text>
    <rect x="450" y="80" width="200" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="550" y="102" text-anchor="middle" fill="#ddd" font-size="11">Balance</text>
    <rect x="650" y="80" width="530" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="665" y="102" fill="#ddd" font-size="11">Good precision + FP32-level range, 50% less memory vs FP32</text>

    <!-- Row 3 -->
    <rect x="0" y="120" width="250" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="15" y="142" fill="#2ecc71" font-size="11" font-weight="bold">Weight Master Copy</text>
    <rect x="250" y="120" width="200" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="350" y="142" text-anchor="middle" fill="#2ecc71" font-size="12" font-weight="bold">FP32</text>
    <rect x="450" y="120" width="200" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="550" y="142" text-anchor="middle" fill="#ddd" font-size="11">Stability</text>
    <rect x="650" y="120" width="530" height="35" fill="#0a0a20" stroke="#222" stroke-width="0.5"/>
    <text x="665" y="142" fill="#ddd" font-size="11">Captures tiny gradient updates; prevents learning stagnation</text>

    <!-- Row 4 -->
    <rect x="0" y="160" width="250" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="15" y="182" fill="#a18cd1" font-size="11" font-weight="bold">Gradient Accumulation</text>
    <rect x="250" y="160" width="200" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="350" y="182" text-anchor="middle" fill="#a18cd1" font-size="12" font-weight="bold">FP32</text>
    <rect x="450" y="160" width="200" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="550" y="182" text-anchor="middle" fill="#ddd" font-size="11">Precision</text>
    <rect x="650" y="160" width="530" height="35" fill="#0d0d20" stroke="#222" stroke-width="0.5"/>
    <text x="665" y="182" fill="#ddd" font-size="11">Prevents rounding error accumulation over thousands of terms</text>
  </g>

  <!-- ===================== KEY TAKEAWAYS ===================== -->
  <rect x="40" y="2340" width="1320" height="230" rx="14" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <rect x="40" y="2340" width="1320" height="230" rx="14" fill="none" stroke="url(#accent1)" stroke-width="1" opacity="0.4"/>
  <text x="700" y="2380" text-anchor="middle" fill="#fff" font-size="20" font-weight="bold">Key Takeaways â€” Mixed Precision Framework</text>

  <g transform="translate(80, 2400)">
    <rect x="0" y="0" width="395" height="65" rx="8" fill="#0a0a20" stroke="#ff6b6b" stroke-width="1.5"/>
    <text x="20" y="22" fill="#ff6b6b" font-size="12" font-weight="bold">âš¡ Speed: FP8 GEMM = 2Ã— Faster</text>
    <text x="20" y="42" fill="#8b8baa" font-size="11">All matrix multiplies use FP8 for both</text>
    <text x="20" y="57" fill="#8b8baa" font-size="11">forward and backward passes</text>

    <rect x="415" y="0" width="395" height="65" rx="8" fill="#0a0a20" stroke="#43e97b" stroke-width="1.5"/>
    <text x="435" y="22" fill="#43e97b" font-size="12" font-weight="bold">âœ“ Stability: FP32 Where It Matters</text>
    <text x="435" y="42" fill="#8b8baa" font-size="11">Master weights &amp; gradient accumulation in</text>
    <text x="435" y="57" fill="#8b8baa" font-size="11">FP32 preserve learning dynamics</text>

    <rect x="830" y="0" width="390" height="65" rx="8" fill="#0a0a20" stroke="#ffa502" stroke-width="1.5"/>
    <text x="850" y="22" fill="#ffa502" font-size="12" font-weight="bold">ðŸ”„ Online: Dynamic Scaling</text>
    <text x="850" y="42" fill="#8b8baa" font-size="11">Quantization happens per-batch at runtime</text>
    <text x="850" y="57" fill="#8b8baa" font-size="11">No calibration dataset required</text>
  </g>

  <g transform="translate(80, 2480)">
    <rect x="0" y="0" width="600" height="65" rx="8" fill="#0a0a20" stroke="#4facfe" stroke-width="1.5"/>
    <text x="20" y="22" fill="#4facfe" font-size="12" font-weight="bold">ðŸ§  Philosophy: "Right precision for the right operation"</text>
    <text x="20" y="42" fill="#8b8baa" font-size="11">Not all operations need the same precision â€” GEMM can tolerate FP8,</text>
    <text x="20" y="57" fill="#8b8baa" font-size="11">but weight updates and accumulation need FP32 fidelity</text>

    <rect x="620" y="0" width="600" height="65" rx="8" fill="#0a0a20" stroke="#a18cd1" stroke-width="1.5"/>
    <text x="640" y="22" fill="#a18cd1" font-size="12" font-weight="bold">ðŸ“Š Result: No Quality Degradation</text>
    <text x="640" y="42" fill="#8b8baa" font-size="11">DeepSeek's mixed precision training matches BF16-only baseline</text>
    <text x="640" y="57" fill="#8b8baa" font-size="11">quality while being 2Ã— faster for compute-bound GEMM operations</text>
  </g>
</svg>
