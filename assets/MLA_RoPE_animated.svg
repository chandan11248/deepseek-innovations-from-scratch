<svg width="1400" height="900" viewBox="0 0 1400 900"
  xmlns="http://www.w3.org/2000/svg">

  <!-- ═══════════════════════════════════════════════════ DEFS ════ -->
  <defs>
    <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
      <feGaussianBlur stdDeviation="4" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <filter id="glow-strong" x="-60%" y="-60%" width="220%" height="220%">
      <feGaussianBlur stdDeviation="7" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <filter id="shadow">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.4"/>
    </filter>

    <!-- Gradients -->
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#0d1117"/>
      <stop offset="100%" stop-color="#0f172a"/>
    </linearGradient>
    <linearGradient id="panel-grad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#1a2035"/>
      <stop offset="100%" stop-color="#131929"/>
    </linearGradient>
    <linearGradient id="blue-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#1e3a5f"/>
      <stop offset="100%" stop-color="#1a2f4a"/>
    </linearGradient>
    <linearGradient id="purple-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#312e81"/>
      <stop offset="100%" stop-color="#1e1b4b"/>
    </linearGradient>
    <linearGradient id="teal-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#134e4a"/>
      <stop offset="100%" stop-color="#0f3d3a"/>
    </linearGradient>
    <linearGradient id="pink-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#4a1942"/>
      <stop offset="100%" stop-color="#2d1535"/>
    </linearGradient>
    <linearGradient id="rope-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#1e1b4b"/>
      <stop offset="100%" stop-color="#312e81"/>
    </linearGradient>
    <linearGradient id="green-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#14532d"/>
      <stop offset="100%" stop-color="#0a2f1a"/>
    </linearGradient>
    <linearGradient id="output-grad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#3b1f6e"/>
      <stop offset="100%" stop-color="#2a1555"/>
    </linearGradient>

    <!-- Arrow markers -->
    <marker id="a-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#60a5fa"/>
    </marker>
    <marker id="a-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#c084fc"/>
    </marker>
    <marker id="a-teal" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#2dd4bf"/>
    </marker>
    <marker id="a-pink" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#f472b6"/>
    </marker>
    <marker id="a-amber" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#fbbf24"/>
    </marker>
    <marker id="a-lime" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#a3e635"/>
    </marker>
    <marker id="a-cyan" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#22d3ee"/>
    </marker>
    <marker id="a-white" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L10,3 z" fill="#94a3b8"/>
    </marker>
  </defs>

  <!-- ═══════════════════════════════════════════════ STYLES ══════ -->
  <style>
    text { font-family: 'SF Mono','Fira Code','Consolas',monospace; }
    .title   { font-size:20px; font-weight:700; fill:#f1f5f9; letter-spacing:.5px; }
    .sub     { font-size:12px; fill:#64748b; }
    .label   { font-size:10px; fill:#94a3b8; }
    .code    { font-size:10px; fill:#7dd3fc; }
    .code-sm { font-size:9px;  fill:#7dd3fc; }
    .dim     { font-size:9px;  fill:#475569; }
    .ptitle  { font-size:12px; font-weight:700; fill:#e2e8f0; letter-spacing:.4px; }
    .nlbl    { font-size:11px; font-weight:600; }
    .nlbl-sm { font-size:10px; font-weight:600; }
    .section-title { font-size:11px; font-weight:700; fill:#94a3b8; letter-spacing:1px; text-transform:uppercase; }

    @keyframes dash { to { stroke-dashoffset:-24; } }
    .flow { stroke-dasharray:8 4; animation: dash .8s linear infinite; }

    @keyframes pulse-border { 0%,100%{stroke-opacity:.3} 50%{stroke-opacity:.85} }
    .bp { animation: pulse-border 4s ease-in-out infinite; }

    @keyframes rotate-rope { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    @keyframes ph1 { 0%,8%{fill-opacity:1} 4%{fill-opacity:.55} 33%,100%{fill-opacity:1} }
    @keyframes ph2 { 0%,33%{fill-opacity:1} 37%{fill-opacity:.55} 66%,100%{fill-opacity:1} }
    @keyframes ph3 { 0%,66%{fill-opacity:1} 70%{fill-opacity:.55} 100%{fill-opacity:1} }
    .hl1 { animation: ph1 10s linear infinite; }
    .hl2 { animation: ph2 10s linear infinite; }
    .hl3 { animation: ph3 10s linear infinite; }

    @keyframes glow-pulse { 0%,100%{opacity:.6} 50%{opacity:1} }
    .gp { animation: glow-pulse 2s ease-in-out infinite; }
  </style>

  <!-- ═══════════════════════════════════════════ BACKGROUND ══════ -->
  <rect width="1400" height="900" fill="url(#bg)"/>
  <g opacity=".04">
    <line x1="0" y1="100" x2="1400" y2="100" stroke="#94a3b8"/>
    <line x1="0" y1="200" x2="1400" y2="200" stroke="#94a3b8"/>
    <line x1="0" y1="300" x2="1400" y2="300" stroke="#94a3b8"/>
    <line x1="0" y1="400" x2="1400" y2="400" stroke="#94a3b8"/>
    <line x1="0" y1="500" x2="1400" y2="500" stroke="#94a3b8"/>
    <line x1="0" y1="600" x2="1400" y2="600" stroke="#94a3b8"/>
    <line x1="0" y1="700" x2="1400" y2="700" stroke="#94a3b8"/>
    <line x1="0" y1="800" x2="1400" y2="800" stroke="#94a3b8"/>
  </g>


  <!-- ════════════════════════════ SECTION HEADERS (top labels) ═══ -->
  <text x="195" y="55" text-anchor="middle" class="section-title">Compression</text>
  <text x="195" y="70" text-anchor="middle" class="dim" fill="#60a5fa">(Latent)</text>

  <text x="445" y="55" text-anchor="middle" class="section-title">Decompression</text>
  <text x="445" y="70" text-anchor="middle" class="dim" fill="#c084fc">(Up-Projection) &amp; Decoupled Keys</text>

  <text x="700" y="55" text-anchor="middle" class="section-title">RoPE</text>
  <text x="700" y="70" text-anchor="middle" class="dim" fill="#2dd4bf">Implementation</text>

  <text x="1050" y="55" text-anchor="middle" class="section-title">Attention</text>
  <text x="1050" y="70" text-anchor="middle" class="dim" fill="#f472b6">&amp; Output</text>

  <!-- Section divider lines -->
  <line x1="315" y1="80" x2="315" y2="850" stroke="#334155" stroke-width="1" stroke-dasharray="6 6" opacity=".3"/>
  <line x1="590" y1="80" x2="590" y2="850" stroke="#334155" stroke-width="1" stroke-dasharray="6 6" opacity=".3"/>
  <line x1="830" y1="80" x2="830" y2="850" stroke="#334155" stroke-width="1" stroke-dasharray="6 6" opacity=".3"/>


  <!-- ══════════════════════════════════ INPUT (left edge) ════════ -->
  <rect x="20" y="400" width="105" height="60" rx="10" fill="url(#blue-grad)" stroke="#60a5fa" stroke-width="2" class="hl1">
    <animate attributeName="stroke-width" values="2;3;2" dur="3s" repeatCount="indefinite"/>
  </rect>
  <text x="72" y="422" text-anchor="middle" class="nlbl" fill="#60a5fa">Input h_i</text>
  <text x="72" y="438" text-anchor="middle" class="code-sm">(Batch, Seq, H)</text>
  <text x="72" y="452" text-anchor="middle" class="dim">hidden state</text>


  <!-- ═════════════════════════════ COMPRESSION PANEL ═════════════ -->
  <rect x="130" y="85" width="180" height="760" rx="12" fill="url(#panel-grad)" stroke="#3b4f6b" stroke-width="1.5" opacity=".95" class="bp"/>

  <!-- === Projection W_Q box === -->
  <rect x="150" y="280" width="140" height="55" rx="8" fill="url(#blue-grad)" stroke="#3b82f6" stroke-width="2" class="hl1"/>
  <text x="220" y="302" text-anchor="middle" class="nlbl" fill="#60a5fa">Projection</text>
  <text x="220" y="318" text-anchor="middle" class="ptitle" fill="#93c5fd">W_Q</text>
  <text x="220" y="330" text-anchor="middle" class="dim">query projection</text>

  <!-- Arrow: Input → Projection W_Q -->
  <path d="M 125 420 L 150 420 L 150 335 L 150 307" fill="none" stroke="#60a5fa" stroke-width="2" marker-end="url(#a-blue)" class="flow" opacity=".7"/>

  <!-- === Down-projection W_down === -->
  <rect x="150" y="475" width="140" height="55" rx="8" fill="url(#blue-grad)" stroke="#3b82f6" stroke-width="2" class="hl1"/>
  <text x="220" y="493" text-anchor="middle" class="nlbl-sm" fill="#60a5fa">Down-projection</text>
  <text x="220" y="510" text-anchor="middle" class="ptitle" fill="#93c5fd">W_down</text>
  <text x="220" y="525" text-anchor="middle" class="dim">compress KV</text>

  <!-- Arrow: Input → Down-projection -->
  <path d="M 125 440 L 145 440 L 145 502 L 150 502" fill="none" stroke="#60a5fa" stroke-width="2" marker-end="url(#a-blue)" class="flow" opacity=".7"/>

  <!-- === Latent c_QV === -->
  <rect x="150" y="600" width="140" height="65" rx="8" fill="url(#purple-grad)" stroke="#a78bfa" stroke-width="2" class="hl1"/>
  <text x="220" y="618" text-anchor="middle" class="nlbl-sm" fill="#a78bfa">Latent</text>
  <text x="220" y="635" text-anchor="middle" class="ptitle" fill="#c4b5fd">c_QV</text>
  <text x="220" y="650" text-anchor="middle" class="code-sm" fill="#a78bfa">(Compressed KV)</text>
  <text x="220" y="720" text-anchor="middle" class="dim" fill="#a78bfa">Low-Rank Latent</text>

  <!-- Arrow: Down-projection → Latent -->
  <line x1="220" y1="530" x2="220" y2="600" stroke="#a78bfa" stroke-width="2" marker-end="url(#a-purple)" class="flow" opacity=".7"/>


  <!-- ═════════════════════ DECOMPRESSION PANEL ══════════════════ -->
  <rect x="320" y="85" width="265" height="760" rx="12" fill="url(#panel-grad)" stroke="#3b4f6b" stroke-width="1.5" opacity=".95" class="bp"/>

  <!-- === Query q_t === -->
  <rect x="340" y="280" width="120" height="50" rx="8" fill="url(#blue-grad)" stroke="#60a5fa" stroke-width="2" class="hl2"/>
  <text x="400" y="300" text-anchor="middle" class="nlbl" fill="#60a5fa">Query</text>
  <text x="400" y="316" text-anchor="middle" class="ptitle" fill="#93c5fd">q_t</text>

  <!-- Arrow: Projection → Query -->
  <line x1="290" y1="307" x2="340" y2="307" stroke="#60a5fa" stroke-width="2" marker-end="url(#a-blue)" class="flow" opacity=".6"/>

  <!-- === Content Query q_C === -->
  <rect x="430" y="180" width="130" height="50" rx="8" fill="url(#blue-grad)" stroke="#3b82f6" stroke-width="1.5" class="hl2"/>
  <text x="495" y="199" text-anchor="middle" class="nlbl-sm" fill="#60a5fa">Content Query</text>
  <text x="495" y="216" text-anchor="middle" class="ptitle" fill="#93c5fd">q_C</text>

  <!-- Arrow: Query → Content Query -->
  <path d="M 460 290 L 495 290 L 495 230" fill="none" stroke="#60a5fa" stroke-width="1.5" marker-end="url(#a-blue)" opacity=".6"/>

  <!-- === RoPE Query q_R === -->
  <rect x="430" y="310" width="130" height="50" rx="8" fill="url(#teal-grad)" stroke="#2dd4bf" stroke-width="1.5" class="hl2"/>
  <text x="495" y="329" text-anchor="middle" class="nlbl-sm" fill="#2dd4bf">RoPE Query</text>
  <text x="495" y="346" text-anchor="middle" class="ptitle" fill="#5eead4">q_R</text>

  <!-- Arrow: Query → RoPE Query -->
  <path d="M 460 310 L 495 310 L 495 310" fill="none" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" opacity=".6"/>

  <!-- === Up-projection W_up === -->
  <rect x="340" y="475" width="120" height="55" rx="8" fill="url(#purple-grad)" stroke="#a78bfa" stroke-width="2" class="hl2"/>
  <text x="400" y="497" text-anchor="middle" class="nlbl-sm" fill="#a78bfa">Up-projection</text>
  <text x="400" y="514" text-anchor="middle" class="ptitle" fill="#c4b5fd">W_up</text>

  <!-- Arrow: Latent c_QV → Up-projection -->
  <path d="M 290 632 L 310 632 L 310 502 L 340 502" fill="none" stroke="#a78bfa" stroke-width="2" marker-end="url(#a-purple)" class="flow" opacity=".6"/>

  <!-- === Latent c_KV === -->
  <rect x="340" y="570" width="120" height="50" rx="8" fill="url(#purple-grad)" stroke="#a78bfa" stroke-width="1.5" class="hl2"/>
  <text x="400" y="590" text-anchor="middle" class="nlbl-sm" fill="#a78bfa">Latent</text>
  <text x="400" y="606" text-anchor="middle" class="ptitle" fill="#c4b5fd">c_KV</text>

  <!-- Arrow: Up-projection → Latent c_KV -->
  <line x1="400" y1="530" x2="400" y2="570" stroke="#a78bfa" stroke-width="1.5" marker-end="url(#a-purple)" opacity=".6"/>

  <!-- === Content Key k_C === -->
  <rect x="430" y="460" width="130" height="50" rx="8" fill="url(#purple-grad)" stroke="#c084fc" stroke-width="1.5" class="hl2"/>
  <text x="495" y="479" text-anchor="middle" class="nlbl-sm" fill="#c084fc">Content Key</text>
  <text x="495" y="496" text-anchor="middle" class="ptitle" fill="#d8b4fe">k_C</text>

  <!-- Arrow: Latent c_KV → Content Key -->
  <path d="M 460 585 L 530 585 L 530 510" fill="none" stroke="#c084fc" stroke-width="1.5" marker-end="url(#a-purple)" opacity=".5"/>

  <!-- === RoPE Key k_R (Decoupled) === -->
  <rect x="430" y="570" width="130" height="60" rx="8" fill="url(#teal-grad)" stroke="#2dd4bf" stroke-width="1.5" class="hl2"/>
  <text x="495" y="588" text-anchor="middle" class="nlbl-sm" fill="#2dd4bf">RoPE Key</text>
  <text x="495" y="605" text-anchor="middle" class="ptitle" fill="#5eead4">k_R</text>
  <text x="495" y="622" text-anchor="middle" class="dim" fill="#2dd4bf">(Decoupled)</text>

  <!-- Arrow: Latent c_KV → RoPE Key -->
  <path d="M 460 595 L 465 600 L 465 600" fill="none" stroke="#2dd4bf" stroke-width="1.5" opacity=".5"/>

  <!-- === Value v === -->
  <rect x="430" y="690" width="130" height="50" rx="8" fill="url(#purple-grad)" stroke="#c084fc" stroke-width="1.5" class="hl2"/>
  <text x="495" y="709" text-anchor="middle" class="nlbl" fill="#c084fc">Value</text>
  <text x="495" y="726" text-anchor="middle" class="ptitle" fill="#d8b4fe">v</text>

  <!-- Arrow: Latent c_KV → Value -->
  <path d="M 437 620 L 437 690" fill="none" stroke="#c084fc" stroke-width="1.5" marker-end="url(#a-purple)" opacity=".5"/>


  <!-- ══════════════════════════ RoPE IMPLEMENTATION PANEL ════════ -->
  <rect x="595" y="140" width="230" height="590" rx="12" fill="none" stroke="#2dd4bf" stroke-width="2" stroke-dasharray="8 4" opacity=".5"/>
  <text x="710" y="165" text-anchor="middle" class="ptitle" fill="#2dd4bf">Decoupled RoPE</text>

  <!-- === RoPE circle for q_R (top) === -->
  <g transform="translate(670, 300)">
    <circle cx="0" cy="0" r="28" fill="url(#teal-grad)" stroke="#2dd4bf" stroke-width="2" class="hl2"/>
    <!-- Rotating inner ring -->
    <circle cx="0" cy="0" r="20" fill="none" stroke="#5eead4" stroke-width="1.5" stroke-dasharray="6 4" opacity=".7">
      <animateTransform attributeName="transform" type="rotate" dur="3s" from="0" to="360" repeatCount="indefinite"/>
    </circle>
    <!-- Arrow indicators -->
    <path d="M -8,-3 L 8,-3 L 5,-8 M 8,-3 L 5,2" fill="none" stroke="#5eead4" stroke-width="1.5">
      <animateTransform attributeName="transform" type="rotate" dur="3s" from="0" to="360" repeatCount="indefinite"/>
    </path>
  </g>
  <text x="670" y="345" text-anchor="middle" class="code" fill="#2dd4bf">RoPE(q_R)</text>

  <!-- Arrow: RoPE Query → RoPE circle (top) -->
  <line x1="560" y1="335" x2="642" y2="310" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" class="flow" opacity=".6"/>

  <!-- Rotated q_R output -->
  <text x="755" y="288" text-anchor="start" class="nlbl-sm" fill="#2dd4bf">Rotated</text>
  <text x="755" y="303" text-anchor="start" class="ptitle" fill="#5eead4">q_R</text>

  <!-- Arrow: RoPE circle → Rotated q_R (to Attention) -->
  <line x1="698" y1="295" x2="750" y2="295" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" opacity=".6"/>

  <!-- === RoPE circle for k_R (bottom) === -->
  <g transform="translate(670, 530)">
    <circle cx="0" cy="0" r="28" fill="url(#teal-grad)" stroke="#2dd4bf" stroke-width="2" class="hl2"/>
    <!-- Rotating inner ring -->
    <circle cx="0" cy="0" r="20" fill="none" stroke="#5eead4" stroke-width="1.5" stroke-dasharray="6 4" opacity=".7">
      <animateTransform attributeName="transform" type="rotate" dur="3s" from="0" to="360" repeatCount="indefinite"/>
    </circle>
    <path d="M -8,-3 L 8,-3 L 5,-8 M 8,-3 L 5,2" fill="none" stroke="#5eead4" stroke-width="1.5">
      <animateTransform attributeName="transform" type="rotate" dur="3s" from="0" to="360" repeatCount="indefinite"/>
    </path>
  </g>
  <text x="670" y="575" text-anchor="middle" class="code" fill="#2dd4bf">RoPE(k_R)</text>

  <!-- Arrow: RoPE Key → RoPE circle (bottom) -->
  <line x1="560" y1="598" x2="642" y2="538" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" class="flow" opacity=".6"/>

  <!-- Rotated k_R output -->
  <text x="755" y="518" text-anchor="start" class="nlbl-sm" fill="#2dd4bf">Rotated</text>
  <text x="755" y="533" text-anchor="start" class="ptitle" fill="#5eead4">k_R</text>

  <!-- Arrow: RoPE circle (bottom) → Rotated k_R -->
  <line x1="698" y1="525" x2="750" y2="525" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" opacity=".6"/>

  <!-- Annotation -->
  <text x="710" y="640" text-anchor="middle" class="dim" fill="#2dd4bf">Rotation applied ONLY</text>
  <text x="710" y="655" text-anchor="middle" class="dim" fill="#2dd4bf">to decoupled parts</text>


  <!-- ═══════════════════════════ ATTENTION & OUTPUT PANEL ════════ -->
  <rect x="835" y="85" width="545" height="760" rx="12" fill="url(#panel-grad)" stroke="#3b4f6b" stroke-width="1.5" opacity=".95" class="bp"/>

  <!-- === Content Interaction (q_C · k_C) === -->
  <rect x="870" y="175" width="180" height="55" rx="8" fill="url(#blue-grad)" stroke="#60a5fa" stroke-width="1.5" class="hl3"/>
  <text x="960" y="196" text-anchor="middle" class="nlbl-sm" fill="#60a5fa">Content Interaction</text>
  <text x="960" y="215" text-anchor="middle" class="ptitle" fill="#93c5fd">(q_C · k_C)</text>

  <!-- Arrow: Content Query q_C → Content Interaction -->
  <path d="M 560 205 L 870 202" fill="none" stroke="#60a5fa" stroke-width="1.5" marker-end="url(#a-blue)" class="flow" opacity=".5"/>

  <!-- Arrow: Content Key k_C → Content Interaction -->
  <path d="M 560 485 L 840 485 L 840 220 L 870 220" fill="none" stroke="#c084fc" stroke-width="1.5" marker-end="url(#a-purple)" class="flow" opacity=".4"/>

  <!-- === RoPE Interaction === -->
  <rect x="870" y="430" width="180" height="65" rx="8" fill="url(#teal-grad)" stroke="#2dd4bf" stroke-width="1.5" class="hl3"/>
  <text x="960" y="449" text-anchor="middle" class="nlbl-sm" fill="#2dd4bf">RoPE Interaction</text>
  <text x="960" y="466" text-anchor="middle" class="code-sm" fill="#5eead4">(RoPE(q_R) ·</text>
  <text x="960" y="480" text-anchor="middle" class="code-sm" fill="#5eead4"> RoPE(k_R))</text>

  <!-- Arrow: Rotated q_R → RoPE Interaction -->
  <path d="M 800 295 L 835 295 L 835 450 L 870 450" fill="none" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" class="flow" opacity=".5"/>

  <!-- Arrow: Rotated k_R → RoPE Interaction -->
  <path d="M 800 525 L 850 525 L 850 470 L 870 470" fill="none" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-teal)" class="flow" opacity=".5"/>

  <!-- === Combine Scores (+) circle === -->
  <text x="1085" y="315" text-anchor="middle" class="dim" fill="#fbbf24">Combine</text>
  <text x="1085" y="328" text-anchor="middle" class="dim" fill="#fbbf24">Scores</text>
  <circle cx="1085" cy="355" r="22" fill="#422006" stroke="#fbbf24" stroke-width="2.5" class="hl3"/>
  <text x="1085" y="362" text-anchor="middle" class="nlbl" fill="#fbbf24" font-size="18">+</text>

  <!-- Arrow: Content Interaction → + -->
  <path d="M 1050 202 L 1085 202 L 1085 333" fill="none" stroke="#60a5fa" stroke-width="1.5" marker-end="url(#a-amber)" opacity=".6"/>

  <!-- Arrow: RoPE Interaction → + -->
  <path d="M 1050 462 L 1085 462 L 1085 377" fill="none" stroke="#2dd4bf" stroke-width="1.5" marker-end="url(#a-amber)" opacity=".6"/>

  <!-- === Softmax === -->
  <rect x="1140" y="335" width="100" height="42" rx="8" fill="url(#pink-grad)" stroke="#f472b6" stroke-width="1.5" class="hl3"/>
  <text x="1190" y="352" text-anchor="middle" class="nlbl-sm" fill="#f472b6">Softmax</text>
  <text x="1190" y="367" text-anchor="middle" class="code-sm" fill="#f9a8d4">(Att. Weights)</text>

  <!-- Arrow: + → Softmax -->
  <line x1="1107" y1="355" x2="1140" y2="355" stroke="#fbbf24" stroke-width="1.5" marker-end="url(#a-pink)" opacity=".7"/>

  <!-- === Weighted Sum & Projection === -->
  <rect x="1120" y="470" width="150" height="80" rx="10" fill="url(#output-grad)" stroke="#c084fc" stroke-width="2" class="hl3"/>
  <text x="1195" y="493" text-anchor="middle" class="nlbl-sm" fill="#c084fc">Weighted</text>
  <text x="1195" y="508" text-anchor="middle" class="nlbl-sm" fill="#c084fc">Sum &amp;</text>
  <text x="1195" y="523" text-anchor="middle" class="nlbl-sm" fill="#c084fc">Projection</text>
  <text x="1195" y="540" text-anchor="middle" class="code-sm" fill="#d8b4fe">(Output O_i)</text>

  <!-- Arrow: Softmax → Weighted Sum -->
  <path d="M 1195 377 L 1195 470" fill="none" stroke="#f472b6" stroke-width="1.5" marker-end="url(#a-purple)" opacity=".6"/>

  <!-- Arrow: Value v → Weighted Sum -->
  <path d="M 560 715 L 1120 570 L 1120 530" fill="none" stroke="#c084fc" stroke-width="1.5" marker-end="url(#a-purple)" class="flow" stroke-dasharray="6 4" opacity=".4"/>

  <!-- === Final Context Vector === -->
  <rect x="1290" y="490" width="90" height="60" rx="10" fill="url(#green-grad)" stroke="#a3e635" stroke-width="2" class="hl3"/>
  <text x="1335" y="513" text-anchor="middle" class="nlbl-sm" fill="#a3e635">Final</text>
  <text x="1335" y="527" text-anchor="middle" class="nlbl-sm" fill="#a3e635">Context</text>
  <text x="1335" y="541" text-anchor="middle" class="nlbl-sm" fill="#a3e635">Vector</text>

  <!-- Arrow: Weighted Sum → Final Context -->
  <line x1="1270" y1="510" x2="1290" y2="516" stroke="#a3e635" stroke-width="2" marker-end="url(#a-lime)" opacity=".7"/>


  <!-- ═══════════════════════════════════════════ LEGEND ══════════ -->
  <g transform="translate(30, 878)">
    <rect width="12" height="12" rx="2" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1.5" y="-1"/>
    <text x="17" y="9" class="label" fill="#60a5fa">Input / Query</text>

    <rect x="120" width="12" height="12" rx="2" fill="#312e81" stroke="#a78bfa" stroke-width="1.5" y="-1"/>
    <text x="137" y="9" class="label" fill="#a78bfa">Latent / Compressed</text>

    <rect x="290" width="12" height="12" rx="2" fill="#134e4a" stroke="#2dd4bf" stroke-width="1.5" y="-1"/>
    <text x="307" y="9" class="label" fill="#2dd4bf">RoPE (Rotary)</text>

    <rect x="420" width="12" height="12" rx="2" fill="#4a1942" stroke="#f472b6" stroke-width="1.5" y="-1"/>
    <text x="437" y="9" class="label" fill="#f472b6">Softmax / Attention</text>

    <rect x="580" width="12" height="12" rx="2" fill="#3b1f6e" stroke="#c084fc" stroke-width="1.5" y="-1"/>
    <text x="597" y="9" class="label" fill="#c084fc">Key / Value / Output</text>

    <rect x="750" width="12" height="12" rx="2" fill="#14532d" stroke="#a3e635" stroke-width="1.5" y="-1"/>
    <text x="767" y="9" class="label" fill="#a3e635">Final Output</text>

    <line x1="870" y1="5" x2="910" y2="5" stroke="#fbbf24" stroke-width="2" stroke-dasharray="5 3"/>
    <text x="917" y="9" class="label" fill="#fbbf24">Data Flow</text>

    <circle cx="968" cy="4" r="5" fill="none" stroke="#2dd4bf" stroke-width="1.5">
      <animateTransform attributeName="transform" type="rotate" dur="3s" from="0 968 4" to="360 968 4" repeatCount="indefinite"/>
    </circle>
    <text x="978" y="9" class="label" fill="#2dd4bf">RoPE Rotation</text>
  </g>


  <!-- ════════════════════════════════ ANIMATION PARTICLES ════════ -->
  <!--
    14s cycle, 3 phases:
      Phase 1 (0-4.5s): Input → Compression → Decompression
      Phase 2 (4.5-9s): Decompression splits + RoPE rotation
      Phase 3 (9-14s): Attention scores → Combine → Softmax → Output
  -->

  <!-- P1: Input → Projection W_Q -->
  <circle r="5" fill="#60a5fa" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.001;0.06;1" calcMode="linear"
      path="M 125 420 L 150 420 L 150 335 L 150 307"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.001;0.06;0.08;1"/>
  </circle>

  <!-- P2: Input → Down-projection -->
  <circle r="5" fill="#60a5fa" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.02;0.08;1" calcMode="linear"
      path="M 125 440 L 145 440 L 145 502 L 150 502"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.02;0.08;0.10;1"/>
  </circle>

  <!-- P3: Projection → Query q_t -->
  <circle r="4" fill="#60a5fa" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.08;0.14;1" calcMode="linear"
      path="M 290 307 L 340 307"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.08;0.14;0.16;1"/>
  </circle>

  <!-- P4: Down-projection → Latent c_QV -->
  <circle r="4" fill="#a78bfa" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.10;0.16;1" calcMode="linear"
      path="M 220 530 L 220 600"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.10;0.16;0.18;1"/>
  </circle>

  <!-- P5: Latent c_QV → Up-projection -->
  <circle r="4" fill="#a78bfa" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.18;0.25;1" calcMode="linear"
      path="M 290 632 L 310 632 L 310 502 L 340 502"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.18;0.25;0.27;1"/>
  </circle>

  <!-- P6: Query → Content Query q_C -->
  <circle r="4" fill="#60a5fa" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.16;0.22;1" calcMode="linear"
      path="M 460 290 L 495 290 L 495 230"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.16;0.22;0.24;1"/>
  </circle>

  <!-- P7: Query → RoPE Query q_R -->
  <circle r="4" fill="#2dd4bf" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.16;0.22;1" calcMode="linear"
      path="M 460 310 L 495 335"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.16;0.22;0.24;1"/>
  </circle>

  <!-- P8: RoPE Query → RoPE circle (top) -->
  <circle r="5" fill="#2dd4bf" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.28;0.36;1" calcMode="linear"
      path="M 560 335 L 642 310"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.28;0.36;0.38;1"/>
  </circle>

  <!-- P9: RoPE Key → RoPE circle (bottom) -->
  <circle r="5" fill="#2dd4bf" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.30;0.38;1" calcMode="linear"
      path="M 560 598 L 642 538"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.30;0.38;0.40;1"/>
  </circle>

  <!-- P10: Rotated q_R → RoPE Interaction -->
  <circle r="5" fill="#2dd4bf" filter="url(#glow-strong)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.40;0.50;1" calcMode="linear"
      path="M 800 295 L 835 295 L 835 450 L 870 450"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.40;0.50;0.52;1"/>
  </circle>

  <!-- P11: Content Query → Content Interaction -->
  <circle r="5" fill="#60a5fa" filter="url(#glow-strong)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.40;0.50;1" calcMode="linear"
      path="M 560 205 L 870 202"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.40;0.50;0.52;1"/>
  </circle>

  <!-- P12: Content Interaction → + -->
  <circle r="5" fill="#fbbf24" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.55;0.62;1" calcMode="linear"
      path="M 1050 202 L 1085 202 L 1085 333"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.55;0.62;0.64;1"/>
  </circle>

  <!-- P13: RoPE Interaction → + -->
  <circle r="5" fill="#fbbf24" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.55;0.62;1" calcMode="linear"
      path="M 1050 462 L 1085 462 L 1085 377"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.55;0.62;0.64;1"/>
  </circle>

  <!-- P14: + → Softmax -->
  <circle r="4" fill="#f472b6" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.65;0.70;1" calcMode="linear"
      path="M 1107 355 L 1140 355"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.65;0.70;0.72;1"/>
  </circle>

  <!-- P15: Softmax → Weighted Sum -->
  <circle r="5" fill="#c084fc" filter="url(#glow)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.72;0.80;1" calcMode="linear"
      path="M 1195 377 L 1195 470"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.72;0.80;0.82;1"/>
  </circle>

  <!-- P16: Weighted Sum → Final Context -->
  <circle r="6" fill="#a3e635" filter="url(#glow-strong)" opacity="0">
    <animateMotion dur="14s" repeatCount="indefinite"
      keyPoints="0;0;1;1" keyTimes="0;0.84;0.90;1" calcMode="linear"
      path="M 1270 510 L 1290 516"/>
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;1;1;0;0" keyTimes="0;0.84;0.90;0.93;1"/>
  </circle>

  <!-- Output flash ring -->
  <circle cx="1335" cy="520" r="30" fill="none" stroke="#a3e635" stroke-width="2" opacity="0">
    <animate attributeName="opacity" dur="14s" repeatCount="indefinite"
      values="0;0;0.6;0;0" keyTimes="0;0.90;0.94;0.97;1"/>
    <animate attributeName="r" dur="14s" repeatCount="indefinite"
      values="30;30;50;50;30" keyTimes="0;0.90;0.94;0.97;1"/>
  </circle>

  <!-- Credit -->
  <text x="1380" y="895" text-anchor="end" font-family="'SF Mono','Fira Code','Consolas',monospace"
        font-size="11" font-weight="700" fill="#64748b">Illustrated By Chandan11248</text>

</svg>
